<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>XSS Protection Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
    }
    h1 {
      color: #28a745;
      border-bottom: 2px solid #28a745;
      padding-bottom: 10px;
    }
    .test-section {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    button {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #218838;
    }
    .test-case {
      background: rgba(40, 167, 69, 0.1);
      border-left: 3px solid #28a745;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .test-input {
      background: #1a1a1a;
      color: #ffc107;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      word-break: break-all;
    }
    .test-output {
      background: #1a1a1a;
      color: #28a745;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      word-break: break-all;
    }
    .test-result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      font-weight: bold;
    }
    .passed {
      background: #28a745;
      color: white;
    }
    .failed {
      background: #dc3545;
      color: white;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .stat-card {
      background: rgba(40, 167, 69, 0.1);
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #28a745;
    }
    .stat-label {
      color: #aaa;
      font-size: 12px;
      text-transform: uppercase;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      margin-top: 5px;
      color: #28a745;
    }
    .results-summary {
      margin-top: 20px;
      padding: 20px;
      background: rgba(40, 167, 69, 0.1);
      border-radius: 8px;
      border: 2px solid #28a745;
    }
  </style>
</head>
<body>
  <h1>üõ°Ô∏è XSS Protection Test (DOMPurify)</h1>

  <div class="test-section">
    <h2>Test 1: Script Tag Injection</h2>
    <button onclick="runAllTests()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã XSS</button>
    <button onclick="runBuiltInTests()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã sanitizer</button>
    <div id="test-results"></div>
  </div>

  <div class="test-section">
    <h2>Test 2: Manual Input Test</h2>
    <p>–í–≤–µ–¥–∏—Ç–µ HTML/—Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ sanitization:</p>
    <textarea id="manual-input" style="width:100%; height:100px; background:#1a1a1a; color:#fff; border:1px solid #28a745; border-radius:4px; padding:10px; font-family:monospace;"></textarea>
    <br>
    <button onclick="testHTML()">–¢–µ—Å—Ç –∫–∞–∫ HTML</button>
    <button onclick="testText()">–¢–µ—Å—Ç –∫–∞–∫ Text</button>
    <button onclick="testURL()">–¢–µ—Å—Ç –∫–∞–∫ URL</button>
    <div id="manual-results"></div>
  </div>

  <div class="test-section">
    <h2>Test 3: Statistics</h2>
    <button onclick="showStats()">–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
    <button onclick="resetStats()">–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
    <div id="stats-container"></div>
  </div>

  <script type="module">
    // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º sanitizer
    import './src/js/advanced-sanitizer.js';

    // XSS —Ç–µ—Å—Ç–æ–≤—ã–µ –≤–µ–∫—Ç–æ—Ä—ã
    const xssTests = [
      {
        name: 'Script tag',
        input: '<script>alert("XSS")</script>Hello',
        method: 'sanitizeHTML',
        shouldBlock: true,
        expectedOutput: 'Hello'
      },
      {
        name: 'Event handler (onerror)',
        input: '<img src=x onerror="alert(\'XSS\')">',
        method: 'sanitizeHTML',
        shouldBlock: true,
        expectedOutput: ''
      },
      {
        name: 'Event handler (onclick)',
        input: '<div onclick="alert(\'XSS\')">Click me</div>',
        method: 'sanitizeHTML',
        shouldBlock: true,
        expectedOutput: 'Click me' // –°–æ–¥–µ—Ä–∂–∏–º–æ–µ div –¥–æ–ª–∂–Ω–æ –æ—Å—Ç–∞—Ç—å—Å—è
      },
      {
        name: 'JavaScript protocol',
        input: 'javascript:alert("XSS")',
        method: 'sanitizeURL',
        shouldBlock: true,
        expectedOutput: ''
      },
      {
        name: 'Iframe injection',
        input: '<iframe src="malicious.com"></iframe>',
        method: 'sanitizeHTML',
        shouldBlock: true,
        expectedOutput: ''
      },
      {
        name: 'SVG with script',
        input: '<svg onload="alert(\'XSS\')"></svg>',
        method: 'sanitizeHTML',
        shouldBlock: true,
        expectedOutput: ''
      },
      {
        name: 'Style with expression',
        input: '<div style="width: expression(alert(\'XSS\'))">Test</div>',
        method: 'sanitizeHTML',
        shouldBlock: true,
        expectedOutput: 'Test'
      },
      {
        name: 'Valid HTML (bold)',
        input: '<b>Bold text</b>',
        method: 'sanitizeHTML',
        shouldBlock: false,
        expectedOutput: '<b>Bold text</b>'
      },
      {
        name: 'Valid HTML (emphasis)',
        input: '<em>Emphasis</em> and <strong>strong</strong>',
        method: 'sanitizeHTML',
        shouldBlock: false,
        expectedOutput: '<em>Emphasis</em> and <strong>strong</strong>'
      },
      {
        name: 'Valid text',
        input: 'Hello World',
        method: 'sanitizeText',
        shouldBlock: false,
        expectedOutput: 'Hello World'
      },
      {
        name: 'Valid Telegram URL',
        input: 'https://t.me/example',
        method: 'sanitizeURL',
        shouldBlock: false,
        expectedOutput: 'https://t.me/example'
      },
      {
        name: 'Text with HTML tags',
        input: '<script>alert("XSS")</script>Hello',
        method: 'sanitizeText',
        shouldBlock: true,
        expectedOutput: 'Hello' // –í—Å–µ HTML –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É–¥–∞–ª–µ–Ω–æ
      }
    ];

    window.runAllTests = function() {
      const container = document.getElementById('test-results');
      container.innerHTML = '<div style="color:#28a745; margin-bottom:20px;">–ó–∞–ø—É—Å–∫ XSS —Ç–µ—Å—Ç–æ–≤...</div>';

      let passed = 0;
      let failed = 0;

      xssTests.forEach((test, index) => {
        const output = window.advancedSanitizer[test.method](test.input);
        const testPassed = output === test.expectedOutput ||
                          (test.shouldBlock && output.length < test.input.length);

        if (testPassed) passed++;
        else failed++;

        const testDiv = document.createElement('div');
        testDiv.className = 'test-case';
        testDiv.innerHTML = `
          <div style="font-weight:bold; color:#28a745;">
            ${index + 1}. ${test.name} ${testPassed ? '‚úÖ' : '‚ùå'}
          </div>
          <div style="margin-top:5px; color:#aaa; font-size:12px;">
            –ú–µ—Ç–æ–¥: <code>${test.method}</code>
          </div>
          <div class="test-input">
            <strong>–í–≤–æ–¥:</strong> ${escapeHtml(test.input)}
          </div>
          <div class="test-output">
            <strong>–í—ã–≤–æ–¥:</strong> ${escapeHtml(output)}
          </div>
          <div class="test-result ${testPassed ? 'passed' : 'failed'}">
            ${testPassed ? '‚úÖ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù' : '‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù'}
          </div>
        `;
        container.appendChild(testDiv);
      });

      // –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
      const summary = document.createElement('div');
      summary.className = 'results-summary';
      summary.innerHTML = `
        <h3 style="margin-top:0; color:#28a745;">–ò—Ç–æ–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤</div>
            <div class="stat-value">${xssTests.length}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">–ü—Ä–æ–π–¥–µ–Ω–æ</div>
            <div class="stat-value" style="color:#28a745">${passed}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">–ü—Ä–æ–≤–∞–ª–µ–Ω–æ</div>
            <div class="stat-value" style="color:#dc3545">${failed}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">–£—Å–ø–µ—Ö</div>
            <div class="stat-value">${Math.round((passed / xssTests.length) * 100)}%</div>
          </div>
        </div>
        <div style="margin-top:20px; padding:15px; background:${passed === xssTests.length ? '#28a745' : '#dc3545'}; border-radius:6px; text-align:center; font-size:18px; font-weight:bold;">
          ${passed === xssTests.length ? '‚úÖ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´' : `‚ö†Ô∏è ${failed} –¢–ï–°–¢–û–í –ù–ï –ü–†–û–ô–î–ï–ù–û`}
        </div>
      `;
      container.appendChild(summary);
    };

    window.runBuiltInTests = function() {
      const container = document.getElementById('test-results');
      container.innerHTML = '<div style="color:#28a745;">–ó–∞–ø—É—Å–∫ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ sanitizer...</div>';

      const results = window.advancedSanitizer.test();

      container.innerHTML = `
        <div class="results-summary">
          <h3 style="margin-top:0; color:#28a745;">–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã DOMPurify</h3>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤</div>
              <div class="stat-value">${results.total}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">–ü—Ä–æ–π–¥–µ–Ω–æ</div>
              <div class="stat-value" style="color:#28a745">${results.passed}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">–ü—Ä–æ–≤–∞–ª–µ–Ω–æ</div>
              <div class="stat-value" style="color:#dc3545">${results.total - results.passed}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">–£—Å–ø–µ—Ö</div>
              <div class="stat-value">${Math.round((results.passed / results.total) * 100)}%</div>
            </div>
          </div>
          <div style="margin-top:20px; padding:15px; background:${results.success ? '#28a745' : '#dc3545'}; border-radius:6px; text-align:center; font-size:18px; font-weight:bold;">
            ${results.success ? '‚úÖ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´' : '‚ö†Ô∏è –ù–ï–ö–û–¢–û–†–´–ï –¢–ï–°–¢–´ –ù–ï –ü–†–û–ô–î–ï–ù–´'}
          </div>
          <div style="margin-top:20px; padding:15px; background:#1a1a1a; border-radius:6px;">
            <strong>–î–µ—Ç–∞–ª–∏ —Ç–µ—Å—Ç–æ–≤:</strong>
            <pre style="margin-top:10px; color:#aaa; overflow-x:auto;">${JSON.stringify(results.results, null, 2)}</pre>
          </div>
        </div>
      `;
    };

    window.testHTML = function() {
      const input = document.getElementById('manual-input').value;
      const output = window.advancedSanitizer.sanitizeHTML(input);
      displayManualResult('HTML', input, output);
    };

    window.testText = function() {
      const input = document.getElementById('manual-input').value;
      const output = window.advancedSanitizer.sanitizeText(input);
      displayManualResult('Text', input, output);
    };

    window.testURL = function() {
      const input = document.getElementById('manual-input').value;
      const output = window.advancedSanitizer.sanitizeURL(input);
      displayManualResult('URL', input, output);
    };

    function displayManualResult(type, input, output) {
      const container = document.getElementById('manual-results');
      container.innerHTML = `
        <div class="test-case">
          <div style="font-weight:bold; color:#28a745; margin-bottom:10px;">
            –†–µ–∑—É–ª—å—Ç–∞—Ç sanitize${type}:
          </div>
          <div class="test-input">
            <strong>–í–≤–æ–¥:</strong> ${escapeHtml(input)}
          </div>
          <div class="test-output">
            <strong>–í—ã–≤–æ–¥:</strong> ${escapeHtml(output)}
          </div>
          <div style="margin-top:10px; color:#aaa; font-size:13px;">
            –î–ª–∏–Ω–∞: ${input.length} ‚Üí ${output.length} —Å–∏–º–≤–æ–ª–æ–≤
            ${output.length < input.length ? '<span style="color:#28a745;">‚úÖ –ö–æ–Ω—Ç–µ–Ω—Ç –±—ã–ª –æ—á–∏—â–µ–Ω</span>' : ''}
          </div>
        </div>
      `;
    }

    window.showStats = function() {
      const stats = window.advancedSanitizer.getStats();
      const container = document.getElementById('stats-container');

      container.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">–í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
            <div class="stat-value">${stats.totalSanitized}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
            <div class="stat-value" style="color:#dc3545">${stats.blocked}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">–ë–ª–æ–∫ —Ä–µ–π—Ç</div>
            <div class="stat-value">${stats.blockRate}%</div>
          </div>
        </div>
        <div style="margin-top:20px; padding:15px; background:rgba(40,167,69,0.1); border-radius:6px;">
          <strong>–ü–æ —Ç–∏–ø–∞–º:</strong>
          <div class="stats-grid" style="margin-top:10px;">
            <div class="stat-card">
              <div class="stat-label">HTML</div>
              <div class="stat-value">${stats.byType.html}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Text</div>
              <div class="stat-value">${stats.byType.text}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">URL</div>
              <div class="stat-value">${stats.byType.url}</div>
            </div>
          </div>
        </div>
      `;
    };

    window.resetStats = function() {
      window.advancedSanitizer.resetStats();
      document.getElementById('stats-container').innerHTML = '<div style="color:#28a745; padding:15px; background:rgba(40,167,69,0.1); border-radius:6px;">‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞</div>';
    };

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    setTimeout(() => {
      console.log('‚úÖ XSS Protection Test Page loaded');
      console.log('üõ°Ô∏è Available tests:', {
        test1: 'Automated XSS vector tests',
        test2: 'Manual input testing',
        test3: 'Statistics display',
        builtIn: 'DOMPurify built-in tests'
      });
      console.log('üí° Try running tests to verify XSS protection');
    }, 500);
  </script>
</body>
</html>
