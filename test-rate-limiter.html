<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rate Limiter Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
    }
    h1 {
      color: #007bff;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
    }
    .test-section {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .results {
      margin-top: 15px;
      padding: 15px;
      background: rgba(0, 123, 255, 0.1);
      border-left: 3px solid #007bff;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
    }
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .warning { color: #ffc107; }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .stat-card {
      background: rgba(0, 123, 255, 0.1);
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #007bff;
    }
    .stat-label {
      color: #aaa;
      font-size: 12px;
      text-transform: uppercase;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      margin-top: 5px;
      color: #007bff;
    }
  </style>
</head>
<body>
  <h1>üõ°Ô∏è Advanced Rate Limiter Test</h1>

  <div class="test-section">
    <h2>Test 1: Single Operation Limit</h2>
    <p>fetchVacancies –ª–∏–º–∏—Ç: <strong>30 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É</strong></p>
    <button id="test1" onclick="testSingleOperation()">–ó–∞–ø—É—Å—Ç–∏—Ç—å 35 –∑–∞–ø—Ä–æ—Å–æ–≤ fetchVacancies</button>
    <div id="results1" class="results"></div>
  </div>

  <div class="test-section">
    <h2>Test 2: Global Limit</h2>
    <p>–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç: <strong>100 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É</strong></p>
    <button id="test2" onclick="testGlobalLimit()">–ó–∞–ø—É—Å—Ç–∏—Ç—å 105 —Å–º–µ—à–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</button>
    <div id="results2" class="results"></div>
  </div>

  <div class="test-section">
    <h2>Test 3: Different Operations</h2>
    <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ä–∞–∑–Ω—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏</p>
    <button onclick="testDifferentOperations()">–¢–µ—Å—Ç —Ä–∞–∑–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</button>
    <div id="results3" class="results"></div>
  </div>

  <div class="test-section">
    <h2>Test 4: Statistics</h2>
    <button onclick="showStats()">–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
    <button onclick="resetLimiter()">–°–±—Ä–æ—Å–∏—Ç—å rate limiter</button>
    <div id="stats-container"></div>
  </div>

  <script type="module">
    // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º rate limiter
    import './src/js/advanced-rate-limiter.js';

    window.testSingleOperation = async function() {
      const results = document.getElementById('results1');
      results.innerHTML = '<div>–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞...</div>';

      let allowed = 0;
      let blocked = 0;

      for (let i = 1; i <= 35; i++) {
        const result = window.advancedRateLimiter.checkLimit('fetchVacancies');

        if (result.allowed) {
          allowed++;
          results.innerHTML += `<div class="success">‚úÖ –ó–∞–ø—Ä–æ—Å ${i}: –†–∞–∑—Ä–µ—à–µ–Ω</div>`;
        } else {
          blocked++;
          results.innerHTML += `<div class="error">‚ùå –ó–∞–ø—Ä–æ—Å ${i}: –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω - ${result.message}</div>`;
        }

        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
        if (i % 5 === 0) {
          await new Promise(resolve => setTimeout(resolve, 50));
        }
      }

      results.innerHTML += `<div style="margin-top:15px; padding:10px; background:#28a745; border-radius:4px;">
        <strong>–ò—Ç–æ–≥:</strong> –†–∞–∑—Ä–µ—à–µ–Ω–æ: ${allowed}, –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: ${blocked}
        <br>–û–∂–∏–¥–∞–ª–æ—Å—å: 30 —Ä–∞–∑—Ä–µ—à–µ–Ω–æ, 5 –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ
        <br><strong>${allowed === 30 && blocked === 5 ? '‚úÖ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù' : '‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù'}</strong>
      </div>`;

      results.scrollTop = results.scrollHeight;
    };

    window.testGlobalLimit = async function() {
      const results = document.getElementById('results2');
      results.innerHTML = '<div>–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞...</div>';

      // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–æ—Å–∏–º –ª–∏–º–∏—Ç—ã
      window.advancedRateLimiter.reset();

      let allowed = 0;
      let blocked = 0;
      const operations = ['fetchVacancies', 'updateStatus', 'favorite', 'filterVacancies'];

      for (let i = 1; i <= 105; i++) {
        const operation = operations[i % operations.length];
        const result = window.advancedRateLimiter.checkLimit(operation);

        if (result.allowed) {
          allowed++;
          if (i % 10 === 0) {
            results.innerHTML += `<div class="success">‚úÖ –ó–∞–ø—Ä–æ—Å ${i} (${operation}): –†–∞–∑—Ä–µ—à–µ–Ω</div>`;
          }
        } else {
          blocked++;
          results.innerHTML += `<div class="error">‚ùå –ó–∞–ø—Ä–æ—Å ${i} (${operation}): –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω - ${result.message}</div>`;
        }

        if (i % 10 === 0) {
          await new Promise(resolve => setTimeout(resolve, 50));
        }
      }

      results.innerHTML += `<div style="margin-top:15px; padding:10px; background:#28a745; border-radius:4px;">
        <strong>–ò—Ç–æ–≥:</strong> –†–∞–∑—Ä–µ—à–µ–Ω–æ: ${allowed}, –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: ${blocked}
        <br>–û–∂–∏–¥–∞–ª–æ—Å—å: ~100 —Ä–∞–∑—Ä–µ—à–µ–Ω–æ, ~5 –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç)
        <br><strong>${blocked >= 5 ? '‚úÖ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù' : '‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã'}</strong>
      </div>`;

      results.scrollTop = results.scrollHeight;
    };

    window.testDifferentOperations = async function() {
      const results = document.getElementById('results3');
      results.innerHTML = '<div>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π...</div>';

      window.advancedRateLimiter.reset();

      const operations = [
        { name: 'fetchVacancies', limit: 30, tests: 35 },
        { name: 'updateStatus', limit: 20, tests: 25 },
        { name: 'favorite', limit: 10, tests: 15 },
        { name: 'filterVacancies', limit: 50, tests: 55 }
      ];

      for (const op of operations) {
        results.innerHTML += `<div style="margin-top:10px; color:#ffc107;">
          <strong>–¢–µ—Å—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏: ${op.name}</strong> (–ª–∏–º–∏—Ç: ${op.limit}/–º–∏–Ω)
        </div>`;

        let allowed = 0;
        let blocked = 0;

        for (let i = 1; i <= op.tests; i++) {
          const result = window.advancedRateLimiter.checkLimit(op.name);
          if (result.allowed) {
            allowed++;
          } else {
            blocked++;
          }
        }

        const passed = allowed === op.limit && blocked === (op.tests - op.limit);
        results.innerHTML += `<div class="${passed ? 'success' : 'error'}">
          ${passed ? '‚úÖ' : '‚ùå'} ${op.name}: –†–∞–∑—Ä–µ—à–µ–Ω–æ ${allowed}/${op.limit}, –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ ${blocked}/${op.tests - op.limit}
        </div>`;

        window.advancedRateLimiter.reset();
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      results.scrollTop = results.scrollHeight;
    };

    window.showStats = function() {
      const stats = window.advancedRateLimiter.getStats();
      const container = document.getElementById('stats-container');

      container.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</div>
            <div class="stat-value">${stats.totalRequests}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">–†–∞–∑—Ä–µ—à–µ–Ω–æ</div>
            <div class="stat-value" style="color:#28a745">${stats.allowedRequests}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
            <div class="stat-value" style="color:#dc3545">${stats.blockedRequests}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">–ë–ª–æ–∫ —Ä–µ–π—Ç</div>
            <div class="stat-value">${stats.blockRate}%</div>
          </div>
        </div>
        <div style="margin-top:20px; padding:15px; background:rgba(0,123,255,0.1); border-radius:6px;">
          <strong>–ü–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º:</strong>
          <pre style="margin-top:10px; color:#aaa;">${JSON.stringify(stats.byOperation, null, 2)}</pre>
        </div>
      `;
    };

    window.resetLimiter = function() {
      window.advancedRateLimiter.reset();
      document.getElementById('stats-container').innerHTML = '<div class="success">‚úÖ Rate limiter —Å–±—Ä–æ—à–µ–Ω</div>';
    };

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    setTimeout(() => {
      console.log('‚úÖ Rate Limiter Test Page loaded');
      console.log('üìä Available tests:', {
        test1: 'Single operation limit (fetchVacancies: 30/min)',
        test2: 'Global limit (100/min total)',
        test3: 'Different operations with different limits',
        test4: 'Statistics display'
      });
    }, 500);
  </script>
</body>
</html>
