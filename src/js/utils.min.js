(function(){'use strict';const tg=(window.Telegram && window.Telegram.WebApp)? window.Telegram.WebApp : null;const CFG=window.APP_CONFIG ||{};function uiToast(message='',options={}){const{onUndo,onTimeout,timeout=3000}=options;const toastContainer=document.getElementById('toast-container');if(!toastContainer){void 0;return}const toast=document.createElement('div');toast.className='toast';const textEl=document.createElement('span');textEl.textContent=message;toast.appendChild(textEl);let actionTimeout;const removeToast=()=>{toast.classList.remove('show');setTimeout(()=>{if(toast.parentElement){toast.parentElement.removeChild(toast)}},300)};if(typeof onUndo==='function'){const undoBtn=document.createElement('button');undoBtn.className='toast-undo-btn';undoBtn.textContent='Отменить';undoBtn.onclick=(e)=>{e.stopPropagation();clearTimeout(actionTimeout);onUndo();removeToast()};toast.appendChild(undoBtn)}toastContainer.appendChild(toast);requestAnimationFrame(()=>{toast.classList.add('show')});actionTimeout=setTimeout(()=>{removeToast();if(onTimeout){onTimeout()}},timeout)}const safeAlert=(msg)=>{if(tg && typeof tg.showAlert==='function'){try{tg.showAlert(String(msg))}catch(e){uiToast(String(msg))}}else uiToast(String(msg))};function showCustomConfirm(message){return new Promise(resolve=>{const confirmOverlay=document.querySelector('#custom-confirm-overlay');if(!confirmOverlay)return resolve(window.confirm(message));const confirmText=confirmOverlay.querySelector('#custom-confirm-text');const confirmOkBtn=confirmOverlay.querySelector('#confirm-btn-ok');const confirmCancelBtn=confirmOverlay.querySelector('#confirm-btn-cancel');if(!confirmText || !confirmOkBtn || !confirmCancelBtn){return resolve(window.confirm(message))}confirmText.textContent=message;confirmOverlay.classList.remove('hidden');const close=(result)=>{confirmOverlay.classList.add('hidden');confirmOkBtn.onclick=null;confirmCancelBtn.onclick=null;resolve(result)};confirmOkBtn.onclick=()=> close(true);confirmCancelBtn.onclick=()=> close(false)})}function createSupabaseHeaders(options={}){const{prefer}=options;const headers={'apikey': CFG.SUPABASE_ANON_KEY,'Authorization': `Bearer ${CFG.SUPABASE_ANON_KEY}`,'Content-Type': 'application/json',};if(prefer){headers['Prefer']=prefer}return headers}const escapeHtml=(s='')=> String(s).replace(/[&<>"']/g,c=>({'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#39;'}[c]));const stripTags=(html='')=>{if(!html)return '';const tmp=document.createElement('div');tmp.textContent=html;return tmp.textContent || ''};const debounce=(fn,delay=250)=>{let t;return(...args)=>{clearTimeout(t);t=setTimeout(()=> fn(...args),delay)}};const highlightText=(text='',q='')=>{if(!q)return escapeHtml(text);const rx=new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi');return escapeHtml(text).replace(rx,'<mark class="highlight">$1</mark>')};const setHighlightedText=(element,text,query)=>{if(!query){element.textContent=text;return}element.textContent='';const rx=new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi');const parts=text.split(rx);parts.forEach((part,i)=>{if(i % 2===1){const mark=document.createElement('mark');mark.className='highlight';mark.textContent=part;element.appendChild(mark)}else{if(part){element.appendChild(document.createTextNode(part))}}})};function sanitizeLink(raw=''){let s=String(raw).trim();if(!s)return '';const ALLOWED_PROTOCOLS=['https:','http:','tg:'];const ALLOWED_DOMAINS=['t.me','telegram.me','telegram.org'];if(/^(t\.me|telegram\.me)\//i.test(s)){s='https://'+s}if(!/^[a-z]+:\/\//i.test(s) && s.includes('.')){s='https://'+s}try{const url=new URL(s);if(!ALLOWED_PROTOCOLS.includes(url.protocol)){return ''}if(url.protocol==='https:' && url.hostname){const hostname=url.hostname.toLowerCase();if(hostname.startsWith('t.me')|| hostname.startsWith('telegram.me')|| ALLOWED_DOMAINS.some(domain=> hostname===domain || hostname.endsWith('.'+domain))){return url.href}if(hostname.match(/^[a-z0-9.-]+\.[a-z]{2,}$/i)){return url.href}}if(url.protocol==='tg:'){return url.href}if(url.protocol==='http:' && url.hostname && url.hostname.match(/^[a-z0-9.-]+\.[a-z]{2,}$/i)){return url.href}}catch(e){}return ''}function openLink(url){let safeUrl=sanitizeLink(url);if(!safeUrl)return;if(safeUrl.startsWith('tg:')){const username=safeUrl.replace('tg:','');safeUrl=`https://t.me/${username}`}if(safeUrl.startsWith('https://t.me') || safeUrl.startsWith('https://telegram.me')){if(tg && typeof tg.openTelegramLink==='function'){tg.openTelegramLink(safeUrl)}else{window.open(safeUrl,'_blank','noopener')}}else{if(tg && typeof tg.openLink==='function'){tg.openLink(safeUrl)}else{window.open(safeUrl,'_blank','noopener')}}}function formatSmartTime(isoString){if(!isoString)return '';const d=new Date(isoString);const now=new Date();const diffMs=now-d;const sec=Math.floor(diffMs/1000);const min=Math.floor(sec/60);const pad=n=> n.toString().padStart(2,'0');const months=['янв','фев','мар','апр','мая','июн','юл','авг','сен','окт','ноя','дек'];const isSameDay=now.toDateString()===d.toDateString();const yest=new Date(now);yest.setDate(now.getDate()-1);const isYesterday=yest.toDateString()===d.toDateString();if(sec < 30)return 'только что';if(min < 60 && min >=1)return `${min}мин назад`;if(isSameDay)return `сегодня, ${pad(d.getHours())}:${pad(d.getMinutes())}`;if(isYesterday)return `вчера, ${pad(d.getHours())}:${pad(d.getMinutes())}`;return `${d.getDate().toString().padStart(2,'0')} ${months[d.getMonth()]}, ${pad(d.getHours())}:${pad(d.getMinutes())}`}const formatTimestamp=(s)=> formatSmartTime(s);function isVacancyNew(dateString){if(!dateString)return false;try{const vacancyDate=new Date(dateString);const now=new Date();const diffMs=now-vacancyDate;const diffHours=diffMs/(1000*60*60);return diffHours <=3}catch(error){void 0;return false}}function parseTotal(resp){const cr=resp.headers.get('content-range');if(!cr || !cr.includes('/'))return 0;const total=cr.split('/').pop();return Number(total)|| 0}const containsImageMarker=(text='')=>/(\[\s*изображени[ея]\s*\]|\b(изображени[ея]|фото|картинк\w|скрин)\b)/i.test(text);const cleanImageMarkers=(text='')=> String(text).replace(/\[\s*изображени[ея]\s*\]/gi,'').replace(/\s{2,}/g,' ').trim();function pickImageUrl(v,detailsText=''){const msg=sanitizeLink(v.message_link || '');const img=sanitizeLink(v.image_link || '');const allow=(v.has_image===true)|| containsImageMarker(detailsText)|| containsImageMarker(v.reason || '');if(!allow)return '';if(msg)return msg;if(img)return img;return ''}async function fetchWithRetry(url,options={},retryCfg={retries: 0,backoffMs: 300}){let attempt=0;let lastErr=null;if(!url || typeof url !=='string'){throw new Error('fetchWithRetry: некорректный URL')}const maxRetries=Math.max(0,Math.min(5,retryCfg.retries || 0));const backoffMs=Math.max(100,Math.min(5000,retryCfg.backoffMs || 300));while(attempt <=maxRetries){try{const response=await fetch(url,options);if(!response.ok){const error=new Error(`HTTP ${response.status}: ${response.statusText}`);error.status=response.status;error.response=response;if(response.status===400 || response.status===401 || response.status===403 || response.status===404){throw error}if(response.status >=500 && attempt < maxRetries){lastErr=error;throw error}throw error}return response}catch(e){lastErr=e;if(typeof console !=='undefined' && console.warn){void 0}if(attempt===maxRetries){break}const shouldRetry=e.name==='TypeError' || e.name==='AbortError' ||(e.status && e.status >=500);if(!shouldRetry){break}const delay=backoffMs*Math.pow(2,attempt)+Math.random()*100;await new Promise(r=> setTimeout(r,delay));attempt++}}const finalError=lastErr || new Error('Network error');if(lastErr && lastErr.status){finalError.message=`Запрос не удался после ${maxRetries+1} попыток. Последняя ошибка: HTTP ${lastErr.status}`}else{finalError.message=`Сетевая ошибка после ${maxRetries+1} попыток: ${lastErr?.message || 'Неизвестная ошибка'}`}throw finalError}function renderEmptyState(container,message){if(!container){void 0;return}const emptyDiv=document.createElement('div');emptyDiv.className='empty-state';const img=document.createElement('img');img.className='empty-state-gif';img.alt='Загрузка изображения';img.src='https://oshu-vacancies.github.io/oshuwork-mini-app/oshuwork.gif';const p=document.createElement('p');p.className='empty-state-text';p.textContent=message;emptyDiv.appendChild(img);emptyDiv.appendChild(p);container.innerHTML='';container.appendChild(emptyDiv)}function renderError(container,message,onRetry){if(!container){void 0;return}const emptyDiv=document.createElement('div');emptyDiv.className='empty-state';const p=document.createElement('p');p.className='empty-state-text';p.textContent=`Ошибка: ${message || 'Ошибка сети'}`;const wrapDiv=document.createElement('div');wrapDiv.className='load-more-wrap';const btn=document.createElement('button');btn.className='load-more-btn';btn.textContent='Повторить';const retryHandler=()=>{if(typeof onRetry==='function'){onRetry()}};btn.addEventListener('click',retryHandler);container.retryCleanup=()=>{btn.removeEventListener('click',retryHandler)};wrapDiv.appendChild(btn);emptyDiv.appendChild(p);emptyDiv.appendChild(wrapDiv);container.innerHTML='';container.appendChild(emptyDiv)}function ensureLoadMore(container,onClick){let wrap=container.querySelector('.load-more-wrap');let btn=container.querySelector('.load-more-btn');if(!wrap){wrap=document.createElement('div');wrap.className='load-more-wrap';btn=document.createElement('button');btn.className='load-more-btn';btn.type='button';btn.textContent='Загрузить ещё';wrap.appendChild(btn);container.appendChild(wrap)}btn.onclick=onClick;return{wrap,btn}}function updateLoadMore(container,visible){let wrap=container.querySelector('.load-more-wrap');if(!wrap)return;wrap.style.display=visible ? '' : 'none'}function createVacancyCard(v,options={}){const{pageType='main',searchQuery=''}=options;const template=document.getElementById('vacancy-card-template');if(!template){void 0;if(window.TemplateLoader && !window.TEMPLATE_READY){window.TemplateLoader.loadVacancyCardTemplate();}const el=document.createElement('div');el.textContent='Ошибка: шаблон не найден.';return el}const card=template.content.cloneNode(true).querySelector('.vacancy-card');if(!card){void 0;const el=document.createElement('div');el.textContent='Ошибка: структура шаблона неверна.';return el}card.id=`card-${v.id}`;if(v.category===(CFG.CATEGORIES?.MAIN||'ТОЧНО ТВОЁ'))card.classList.add('category-main');else if(v.category===(CFG.CATEGORIES?.MAYBE||'МОЖЕТ БЫТЬ'))card.classList.add('category-maybe');else card.classList.add('category-other');const isNew=isVacancyNew(v.timestamp);if(isNew){const newBadge=document.createElement('div');newBadge.className='new-badge';newBadge.textContent='NEW';card.appendChild(newBadge)}const elements={applyBtn: card.querySelector('[data-element="apply-btn"]'),favoriteBtn: card.querySelector('[data-element="favorite-btn"]'),deleteBtn: card.querySelector('[data-element="delete-btn"]'),category: card.querySelector('[data-element="category"]'),summary: card.querySelector('[data-element="summary"]'),infoWindow: card.querySelector('[data-element="info-window"]'),details: card.querySelector('[data-element="details"]'),attachments: card.querySelector('[data-element="attachments"]'),fullText: card.querySelector('[data-element="full-text"]'),skills: card.querySelector('[data-element="skills"]'),channel: card.querySelector('[data-element="channel"]'),timestamp: card.querySelector('[data-element="timestamp"]'),metaSeparator: card.querySelector('.meta-separator'),};const applyUrl=sanitizeLink(v.apply_url || '');if(applyUrl){elements.applyBtn.dataset.action='apply';elements.applyBtn.dataset.url=applyUrl}else{elements.applyBtn.remove()}if(pageType==='main'){elements.favoriteBtn.dataset.action='favorite';elements.favoriteBtn.dataset.id=v.id}else if(pageType==='favorites'){elements.favoriteBtn.dataset.action='favorite';elements.favoriteBtn.dataset.id=v.id;elements.favoriteBtn.title='Убрать из избранного';elements.favoriteBtn.setAttribute('aria-label','Убрать из избранного');elements.favoriteBtn.innerHTML=`<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><title>Убрать из избранного</title><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54z"/><line x1="3" y1="3" x2="21" y2="21" stroke-width="2"/></svg>`;const actionsContainer=elements.favoriteBtn.parentElement;if(actionsContainer && elements.applyBtn && elements.deleteBtn){actionsContainer.innerHTML='';actionsContainer.appendChild(elements.applyBtn);actionsContainer.appendChild(elements.favoriteBtn);actionsContainer.appendChild(elements.deleteBtn)}}else{elements.favoriteBtn.remove()}elements.deleteBtn.dataset.action='delete';elements.deleteBtn.dataset.id=v.id;elements.category.textContent=v.category || 'NO_CATEGORY';const summaryText=v.reason || 'Описание не было сгенерировано.';elements.summary.dataset.originalSummary=summaryText;setHighlightedText(elements.summary,summaryText,searchQuery);const infoRows=[];const cleanVal=val=> String(val ?? '').replace(/[«»"""'''`']/g,'').trim();const isMeaningful=val=> !!cleanVal(val)&& !['не указано','n/a'].includes(cleanVal(val).toLowerCase());const fmt=[v.employment_type,v.work_format].map(cleanVal).filter(isMeaningful).join(' / ');if(fmt)infoRows.push({label: 'ФОРМАТ',value: fmt,type: 'default'});if(isMeaningful(v.salary_display_text))infoRows.push({label: 'ОПЛАТА',value: cleanVal(v.salary_display_text),type: 'salary'});if(isMeaningful(v.industry))infoRows.push({label: 'СФЕРА',value: cleanVal(v.industry),type: 'industry'});if(infoRows.length > 0){infoRows.forEach(r=>{const row=document.createElement('div');row.className=`info-row info-row--${r.type}`;row.innerHTML=`<div class="info-label">${escapeHtml(r.label)}>></div><div class="info-value">${escapeHtml(r.value)}</div>`;elements.infoWindow.appendChild(row)})}else{elements.infoWindow.remove()}const originalDetailsHtml=String(v.text_highlighted || '').replace(/\[\s*Изображение\s*\]\s*/gi,'');const bestImageUrl=pickImageUrl(v,originalDetailsHtml);if(bestImageUrl){const imgBtn=document.createElement('a');imgBtn.className='image-link-button';imgBtn.href=bestImageUrl;imgBtn.target='_blank';imgBtn.rel='noopener noreferrer';imgBtn.textContent='Изображение';elements.attachments.appendChild(imgBtn)}if(originalDetailsHtml){const allowedTags=/<\/?(?:br|p|strong|b|em|i|u|span|div)(?:\s[^>]*)?>|&[a-zA-Z0-9#]+;/gi;const safeHtml=originalDetailsHtml .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,'').replace(/on\w+\s*=\s*"[^"]*"/gi,'').replace(/javascript:/gi,'').replace(/data:/gi,'').replace(/<iframe\b[^>]*>/gi,'').replace(/<object\b[^>]*>/gi,'').replace(/<embed\b[^>]*>/gi,'');elements.fullText.innerHTML=safeHtml}if(!bestImageUrl && !originalDetailsHtml){elements.details.remove()}if(Array.isArray(v.skills)&& v.skills.length > 0){v.skills.slice(0,3).forEach(s=>{const tag=document.createElement('span');tag.className='footer-skill-tag';tag.textContent=s;elements.skills.appendChild(tag)})}else{elements.skills.remove()}if(v.channel){elements.channel.textContent=v.channel}else{elements.channel.remove();elements.metaSeparator.remove()}elements.timestamp.textContent=formatTimestamp(v.timestamp);const searchChunks=[ v.category,v.reason,v.industry,v.company_name,Array.isArray(v.skills)? v.skills.join(' '): '',stripTags(originalDetailsHtml)].filter(Boolean);card.dataset.searchText=searchChunks.join(' ').toLowerCase();const leftIcon=document.createElement('div');leftIcon.className='swipe-icon left';leftIcon.textContent='✕';card.appendChild(leftIcon);const rightIcon=document.createElement('div');rightIcon.className='swipe-icon right';rightIcon.textContent='★';card.appendChild(rightIcon);card.dataset.vacancyData=JSON.stringify(v);return card}class RateLimiter{constructor(options={}){this.tokensPerInterval=options.tokensPerInterval || 1;this.interval=this.parseInterval(options.interval || 1000);this.bucketSize=options.bucketSize || this.tokensPerInterval;this.tokens=this.bucketSize;this.lastRefill=Date.now();this.fireImmediately=options.fireImmediately || false}parseInterval(interval){if(typeof interval==='number')return interval;if(typeof interval==='string'){switch(interval.toLowerCase()){case 'second': return 1000;case 'minute': return 60*1000;case 'hour': return 60*60*1000;case 'day': return 24*60*60*1000;default: return parseInt(interval)|| 1000}}return 1000}refillTokens(){const now=Date.now();const timePassed=now-this.lastRefill;const tokensToAdd=Math.floor(timePassed/this.interval*this.tokensPerInterval);if(tokensToAdd > 0){this.tokens=Math.min(this.bucketSize,this.tokens+tokensToAdd);this.lastRefill=now}}async removeTokens(count=1){this.refillTokens();if(this.fireImmediately){if(this.tokens >=count){this.tokens-=count;return this.tokens}else{return-1}}else{while(this.tokens < count){const waitTime=Math.ceil((count-this.tokens)/this.tokensPerInterval*this.interval);await new Promise(resolve=> setTimeout(resolve,waitTime));this.refillTokens()}this.tokens-=count;return this.tokens}}tryRemoveTokens(count=1){this.refillTokens();if(this.tokens >=count){this.tokens-=count;return true}return false}getTokensRemaining(){this.refillTokens();return this.tokens}}const rateLimiters={loadVacancies: new RateLimiter({tokensPerInterval: 1,interval: 2000,fireImmediately: true}),search: new RateLimiter({tokensPerInterval: 3,interval: 5000,fireImmediately: true}),favorite: new RateLimiter({tokensPerInterval: 5,interval: 'minute',fireImmediately: true}),updateStatus: new RateLimiter({tokensPerInterval: 10,interval: 'minute',fireImmediately: true}),refresh: new RateLimiter({tokensPerInterval: 1,interval: 3000,fireImmediately: true})};async function checkRateLimit(operation,count=1){const limiter=rateLimiters[operation];if(!limiter){void 0;return{allowed: true}}const remaining=await limiter.removeTokens(count);if(remaining < 0){const messages={loadVacancies: 'Подождите 2 секунды перед следующей загрузкой',search: 'Слишком много поисковых запросов. Подождите 5 секунд',favorite: 'Лимит добавления в избранное превышен. Подождите минуту',updateStatus: 'Слишком много обновлений. Подождите минуту',refresh: 'Подождите 3 секунды перед повторным обновлением'};return{allowed: false,message: messages[operation] || 'Слишком много запросов. Подождите немного',remainingTokens: 0}}return{allowed: true,remainingTokens: remaining}}function setupPullToRefresh(options={}){const{onRefresh,refreshEventName}=options;if(typeof onRefresh !=='function' || !refreshEventName){return}const isMiniApp=tg && tg.initDataUnsafe && tg.initDataUnsafe.user;const wrapper=document.querySelector('.main-wrapper');const ptrBar=wrapper?.querySelector('.ptr-bar');if(!wrapper || !ptrBar){return}ptrBar.innerHTML=` <div class="ptr-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"> <line x1="12" y1="5" x2="12" y2="19"></line> <polyline points="19 12 12 19 5 12"></polyline> </svg> </div> <div class="ptr-spinner retro-spinner-inline"></div> <span class="ptr-text">Потяните для обновления</span> `;const ptrText=ptrBar.querySelector('.ptr-text');const THRESHOLD=isMiniApp ? 15 :(CFG.PTR_CONFIG?.THRESHOLD || 60);const BAR_HEIGHT=CFG.PTR_CONFIG?.BAR_HEIGHT || 75;let startY=0;let pullDistance=0;let state='waiting';const setState=(newState)=>{if(state===newState)return;state=newState;switch(state){case 'waiting': wrapper.classList.remove('ptr-pulling');ptrBar.classList.remove('ptr-visible','ptr-ready','ptr-refreshing');wrapper.style.transition='transform 0.3s ease-out';wrapper.style.transform='translateY(0px)';break;case 'pulling': wrapper.classList.add('ptr-pulling');ptrBar.classList.add('ptr-visible');break;case 'refreshing': wrapper.classList.remove('ptr-pulling');ptrBar.classList.add('ptr-refreshing');wrapper.style.transition='transform 0.3s ease-out';wrapper.style.transform=`translateY(${BAR_HEIGHT}px)`;ptrText.textContent='Обновление...';if(tg && tg.HapticFeedback && tg.HapticFeedback.impactOccurred){try{if(tg.version && parseFloat(tg.version)>=6.1){tg.HapticFeedback.impactOccurred('medium')}}catch(error){void 0}}checkRateLimit('refresh').then(rateResult=>{if(!rateResult.allowed){ptrText.textContent=rateResult.message;setTimeout(()=> setState('waiting'),2000);return}if(typeof onRefresh==='function'){onRefresh(true)}});const safetyTimeout=setTimeout(()=>{if(state==='refreshing')setState('waiting')},8000);const onLoaded=()=>{clearTimeout(safetyTimeout);document.removeEventListener(refreshEventName,onLoaded);setState('waiting')};document.addEventListener(refreshEventName,onLoaded);break}};const handleTouchStart=(e)=>{if(state !=='waiting' || window.scrollY > 0)return;const touchY=e.touches[0].clientY;const safeZone=isMiniApp ? 5 : 30;if(touchY < safeZone)return;startY=touchY};const handleTouchMove=(e)=>{if(state==='waiting' && startY !==0){const currentY=e.touches[0].clientY;const moveDistance=currentY-startY;const activationThreshold=isMiniApp ? 10 : 15;if(moveDistance > activationThreshold){setState('pulling');ptrBar.classList.add('ptr-visible')}return}if(state !=='pulling')return;pullDistance=e.touches[0].clientY-startY;if(pullDistance > 0){try{if(e.cancelable){e.preventDefault()}}catch(error){void 0}const resistance=isMiniApp ? 0.6 : 0.7;const dragDistance=Math.pow(pullDistance,resistance);wrapper.style.transform=`translateY(${dragDistance}px)`;wrapper.style.transition='transform 0.1s ease-out';if(isMiniApp){if(dragDistance > 15){ptrBar.classList.add('ptr-ready');ptrText.textContent='Отпустите для обновления'}else{ptrBar.classList.remove('ptr-ready');ptrText.textContent='Потяните для обновления'}}else{if(dragDistance > THRESHOLD){ptrBar.classList.add('ptr-ready');ptrText.textContent='Отпустите для обновления'}else{ptrBar.classList.remove('ptr-ready');ptrText.textContent='Потяните для обновления'}}}};const handleTouchEnd=()=>{if(state==='pulling'){if(isMiniApp){if(pullDistance > 10){setState('refreshing')}else{setState('waiting')}}else{if(Math.pow(pullDistance,0.85)> THRESHOLD){setState('refreshing')}else{setState('waiting')}}pullDistance=0}startY=0};document.body.addEventListener('touchstart',handleTouchStart,{passive: true,capture: true});try{document.body.addEventListener('touchmove',handleTouchMove,{passive: false,capture: true})}catch(error){void 0;document.body.addEventListener('touchmove',handleTouchMove,{passive: true,capture: true})}document.body.addEventListener('touchend',handleTouchEnd,{passive: true,capture: true});wrapper.ptrCleanup=()=>{document.body.removeEventListener('touchstart',handleTouchStart,{capture: true});try{document.body.removeEventListener('touchmove',handleTouchMove,{capture: true})}catch(error){void 0}document.body.removeEventListener('touchend',handleTouchEnd,{capture: true})}}const GlobalCleanupManager={listeners: new Set(),addManagedListener(element,event,handler,options={}){if(!element)return null;element.addEventListener(event,handler,options);const listenerInfo={element,event,handler,options};this.listeners.add(listenerInfo);return()=>{this.removeManagedListener(listenerInfo)}},removeManagedListener(listenerInfo){const{element,event,handler}=listenerInfo;try{element.removeEventListener(event,handler);this.listeners.delete(listenerInfo)}catch(error){void 0}},cleanup(){for(const listenerInfo of this.listeners){this.removeManagedListener(listenerInfo)}this.listeners.clear()},getStats(){return{totalListeners: this.listeners.size,types: Array.from(this.listeners).reduce((acc,{event})=>{acc[event]=(acc[event] || 0)+1;return acc},{})}}};function setupTelegramCleanup(){if(!tg)return;GlobalCleanupManager.addManagedListener(window,'beforeunload',()=>{GlobalCleanupManager.cleanup();window.appController?.destroy();window.eventManager?.destroy()});GlobalCleanupManager.addManagedListener(document,'visibilitychange',()=>{if(document.visibilityState==='hidden'){window.eventManager?.getStats && void 0;window.appController?.getStats && void 0}})}window.utils={tg,escapeHtml,stripTags,debounce,highlightText,setHighlightedText,safeAlert,uiToast,formatTimestamp,sanitizeLink,openLink,containsImageMarker,cleanImageMarkers,pickImageUrl,fetchWithRetry,renderEmptyState,renderError,ensureLoadMore,updateLoadMore,createVacancyCard,setupPullToRefresh,showCustomConfirm,createSupabaseHeaders,parseTotal,checkRateLimit,RateLimiter,GlobalCleanupManager,setupTelegramCleanup};setupTelegramCleanup()})();